# Author: Sourav Chandra
# JSON ‚Üí fully organized, non-truncated Markdown document

import json
from pathlib import Path
from typing import Any


def render_block(title: str, content: str, language: str = "text") -> list[str]:
    return [
        f"### {title}",
        f"```{language}",
        content.rstrip(),
        "```",
        ""
    ]


def render_tool(tool: str, data: dict) -> list[str]:
    lines: list[str] = []

    returncode = data.get("returncode", "N/A")
    stdout = data.get("stdout", "")
    stderr = data.get("stderr", "")

    status = "‚úÖ Clean" if returncode == 0 else "‚ùå Issues detected"

    lines.extend([
        f"## üîß {tool}",
        f"**Return code:** `{returncode}`  ",
        f"**Status:** {status}",
        ""
    ])

    if stdout:
        lines.extend(render_block("Standard Output", stdout))

    if stderr:
        lines.extend(render_block("Standard Error", stderr))

    lines.append("---\n")
    return lines


def render_fallback(key: str, value: Any) -> list[str]:
    return [
        f"## üîß {key}",
        "```text",
        json.dumps(value, indent=2),
        "```",
        "\n---\n"
    ]


def convert(json_path: Path, md_path: Path) -> None:
    with json_path.open("r", encoding="utf-8") as f:
        data = json.load(f)

    md: list[str] = []

    # ---------- Header ----------
    md.extend([
        "# üîç Repository Analyzer Report",
        "",
        "**Generated by:** AI & GenOps Guardian",
        f"**Source JSON:** `{json_path.name}`",
        "",
        "---",
        ""
    ])

    # ---------- Executive Summary ----------
    tools_total = len(data)
    tools_with_findings = sum(
        1 for v in data.values()
        if isinstance(v, dict) and v.get("returncode", 0) != 0
    )

    md.extend([
        "## üìå Executive Summary",
        f"- **Total tools executed:** {tools_total}",
        f"- **Tools with findings:** {tools_with_findings}",
        "",
        "---",
        ""
    ])

    # ---------- Tool-wise Sections ----------
    for key, value in data.items():
        if isinstance(value, dict):
            md.extend(render_tool(key, value))
        else:
            md.extend(render_fallback(key, value))

    md_path.write_text("\n".join(md), encoding="utf-8")


if __name__ == "__main__":
    import sys

    if len(sys.argv) != 3:
        print("Usage: json_to_md.py <input.json> <output.md>")
        raise SystemExit(1)

    convert(Path(sys.argv[1]), Path(sys.argv[2]))
    print("‚úî Full Markdown report generated")
